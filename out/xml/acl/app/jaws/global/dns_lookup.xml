<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.srcML.org/srcML/src" xmlns:cpp="http://www.srcML.org/srcML/cpp" revision="1.0.0" language="C" filename="/workspace/acl/app/jaws/global/dns_lookup.c"><cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"lib_acl.h"</cpp:file></cpp:include>

<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>ACL_BCB_COMPILER</name></cpp:ifdef>
<cpp:pragma>#<cpp:directive>pragma</cpp:directive> <name>hdrstop</name></cpp:pragma>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>

<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"dns.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"dns_lookup.h"</cpp:file></cpp:include>

<cpp:define>#<cpp:directive>define</cpp:directive>	<cpp:macro><name>STRNCPY</name></cpp:macro>	<cpp:value>ACL_SAFE_STRNCPY</cpp:value></cpp:define>

<comment type="block">/*----------------------------------------------------------------------------*/</comment>

<function><type><specifier>static</specifier> <name>void</name></type> <name>inner_nslookup_error</name><parameter_list>(<parameter><decl><type><name>CLIENT_ENTRY</name> <modifier>*</modifier></type><name>entry</name></decl></parameter>)</parameter_list>
<block>{<block_content>
	<if_stmt><if>if <condition>(<expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name> <operator>==</operator> <name>NULL</name></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><call><name>acl_msg_fatal</name><argument_list>(<argument><expr><literal type="string">"%s(%d): client null"</literal></expr></argument>,
			<argument><expr><name>__FILE__</name></expr></argument>, <argument><expr><name>__LINE__</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></if></if_stmt>

	<if_stmt><if>if <condition>(<expr><name><name>entry</name><operator>-&gt;</operator><name>dns_errmsg</name></name></expr>)</condition> <block>{<block_content>
		<expr_stmt><expr><call><name>acl_aio_refer</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><call><name>acl_aio_writen</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name></expr></argument>, <argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_errmsg</name></name></expr></argument>,
			<argument><expr><operator>(</operator><name>int</name><operator>)</operator> <call><name>strlen</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_errmsg</name></name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<comment type="block">/* »Ö¸´referÖµ */</comment>
		<expr_stmt><expr><call><name>acl_aio_unrefer</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></if></if_stmt>

	<expr_stmt><expr><call><name><name>entry</name><operator>-&gt;</operator><name>nslookup_notify_fn</name></name><argument_list>(<argument><expr><name>entry</name></expr></argument>, <argument><expr><name>NSLOOKUP_ERR</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
</block_content>}</block></function>

<function><type><specifier>static</specifier> <name>void</name></type> <name>inner_nslookup_ok</name><parameter_list>(<parameter><decl><type><name>CLIENT_ENTRY</name> <modifier>*</modifier></type><name>entry</name></decl></parameter>, <parameter><decl><type><name>ACL_DNS_DB</name> <modifier>*</modifier></type><name>dns_db</name></decl></parameter>)</parameter_list>
<block>{<block_content>
	<decl_stmt><decl><type><name>ACL_ITER</name></type> <name>iter</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>int</name></type>   <name>i</name> <init>= <expr><literal type="number">0</literal></expr></init></decl>;</decl_stmt>

	<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>ip_idx</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
	<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip_cnt</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
	<macro><name>acl_foreach</name><argument_list>(<argument>iter</argument>, <argument>dns_db</argument>)</argument_list></macro> <block>{<block_content> 
		<decl_stmt><decl><type><specifier>const</specifier> <name>ACL_HOST_INFO</name> <modifier>*</modifier></type><name>info</name></decl>;</decl_stmt>

		<expr_stmt><expr><name>info</name> <operator>=</operator> <operator>(</operator><specifier>const</specifier> <name>ACL_HOST_INFO</name><operator>*</operator><operator>)</operator> <name><name>iter</name><operator>.</operator><name>data</name></name></expr>;</expr_stmt>
		<expr_stmt><expr><call><name>ACL_SAFE_STRNCPY</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip</name><index>[<expr><name>i</name></expr>]</index></name></expr></argument>, <argument><expr><name><name>info</name><operator>-&gt;</operator><name>ip</name></name></expr></argument>,
			<argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip</name><index>[<expr><name>i</name></expr>]</index></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>port</name><index>[<expr><name>i</name><operator>++</operator></expr>]</index></name> <operator>=</operator> <name><name>info</name><operator>-&gt;</operator><name>hport</name></name></expr>;</expr_stmt>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip_cnt</name></name><operator>++</operator></expr>;</expr_stmt>
		<if_stmt><if>if <condition>(<expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip_cnt</name></name> <operator>&gt;=</operator> <name>DNS_IP_MAX</name></expr>)</condition><block type="pseudo"><block_content>
			<break>break;</break></block_content></block></if></if_stmt>
	</block_content>}</block>
	<expr_stmt><expr><call><name><name>entry</name><operator>-&gt;</operator><name>nslookup_notify_fn</name></name><argument_list>(<argument><expr><name>entry</name></expr></argument>, <argument><expr><name>NSLOOKUP_OK</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
</block_content>}</block></function>

<function><type><specifier>static</specifier> <name>void</name></type> <name>inner_nslookup_complete</name><parameter_list>(<parameter><decl><type><name>ACL_DNS_DB</name> <modifier>*</modifier></type><name>dns_db</name></decl></parameter>, <parameter><decl><type><name>void</name> <modifier>*</modifier></type><name>ctx</name></decl></parameter>,
	<parameter><decl><type><name>int</name> <name>errnum</name></type> <name>acl_unused</name></decl></parameter>)</parameter_list>
<block>{<block_content>
	<decl_stmt><decl><type><name>CLIENT_ENTRY</name> <modifier>*</modifier></type><name>entry</name> <init>= <expr><operator>(</operator><name>CLIENT_ENTRY</name><operator>*</operator><operator>)</operator> <name>ctx</name></expr></init></decl>;</decl_stmt>

	<if_stmt><if>if <condition>(<expr><name>dns_db</name> <operator>!=</operator> <name>NULL</name></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><call><name>inner_nslookup_ok</name><argument_list>(<argument><expr><name>entry</name></expr></argument>, <argument><expr><name>dns_db</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></if>
	<else>else<block type="pseudo"><block_content>
		<expr_stmt><expr><call><name>inner_nslookup_error</name><argument_list>(<argument><expr><name>entry</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></else></if_stmt>
</block_content>}</block></function>

<comment type="block">/* ²éÑ¯DNSÐÅÏ¢£¬²ÉÓÃÐ­Òé·¢ËÍµÄ·½Ê½ */</comment>
<function><type><specifier>static</specifier> <name>void</name></type> <name>inner_nslookup</name><parameter_list>(<parameter><decl><type><name>SERVICE</name> <modifier>*</modifier></type><name>service</name></decl></parameter>, <parameter><decl><type><name>CLIENT_ENTRY</name> <modifier>*</modifier></type><name>entry</name></decl></parameter>,
	<parameter><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>domain</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>port</name></decl></parameter>)</parameter_list>
<block>{<block_content>
	<decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>ptr</name></decl>;</decl_stmt>

	<expr_stmt><expr><call><name>STRNCPY</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>, <argument><expr><name>domain</name></expr></argument>,
		<argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>acl_lowercase</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name>ptr</name> <operator>=</operator> <call><name>strchr</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>, <argument><expr><literal type="char">':'</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt><if>if <condition>(<expr><name>ptr</name></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><operator>*</operator><name>ptr</name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt></block_content></block></if></if_stmt>
	<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>server_port</name></name> <operator>=</operator> <name>port</name></expr>;</expr_stmt>
	<if_stmt><if>if <condition>(<expr><name><name>entry</name><operator>-&gt;</operator><name>server_port</name></name> <operator>&lt;=</operator> <literal type="number">0</literal></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>server_port</name></name> <operator>=</operator> <literal type="number">80</literal></expr>;</expr_stmt></block_content></block></if></if_stmt>

	<expr_stmt><expr><call><name>STRNCPY</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>, <argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>,
		<argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>acl_dns_lookup</name><argument_list>(<argument><expr><name><name>service</name><operator>-&gt;</operator><name>dns_handle</name></name></expr></argument>, <argument><expr><name><name>entry</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>,
		<argument><expr><name>inner_nslookup_complete</name></expr></argument>, <argument><expr><name>entry</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
</block_content>}</block></function>

<comment type="block">/*----------------------------------------------------------------------------*/</comment>

<comment type="block">/* DNS²éÑ¯½á¹ûÖ®ºóµÄ»Øµ÷º¯Êý */</comment>
<function><type><specifier>static</specifier> <name>void</name></type> <name>thrpool_nslookup_complete</name><parameter_list>(<parameter><decl><type><specifier>const</specifier> <name>DNS_CTX</name> <modifier>*</modifier></type><name>dns_ctx</name></decl></parameter>)</parameter_list>
<block>{<block_content>
	<decl_stmt><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>myname</name> <init>= <expr><literal type="string">"thrpool_nslookup_complte"</literal></expr></init></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>SERVICE</name> <modifier>*</modifier></type><name>service</name> <init>= <expr><operator>(</operator><name>SERVICE</name> <operator>*</operator><operator>)</operator> <name><name>dns_ctx</name><operator>-&gt;</operator><name>context</name></name></expr></init></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>DNS_RING</name> <modifier>*</modifier></type><name>list</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>ACL_RING</name> <modifier>*</modifier></type><name>ring_ptr</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>CLIENT_ENTRY</name> <modifier>*</modifier></type><name>entry</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>time_t</name></type> <name>inter</name></decl>, <decl><type ref="prev"/><name>now</name></decl>;</decl_stmt>

	<expr_stmt><expr><name>list</name> <operator>=</operator> <operator>(</operator><name>DNS_RING</name> <operator>*</operator><operator>)</operator> <call><name>acl_htable_find</name><argument_list>(<argument><expr><name><name>service</name><operator>-&gt;</operator><name>dns_table</name></name></expr></argument>,
				<argument><expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt><if>if <condition>(<expr><name>list</name> <operator>==</operator> <name>NULL</name></expr>)</condition> <block>{<block_content>
		<expr_stmt><expr><call><name>acl_msg_warn</name><argument_list>(<argument><expr><name>NULL</name></expr></argument>, <argument><expr><literal type="string">"%s: domain(%s) not found maybe handled"</literal></expr></argument>,
			<argument><expr><name>myname</name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return;</return>
	</block_content>}</block></if></if_stmt>

	<expr_stmt><expr><call><name>time</name><argument_list>(<argument><expr><operator>&amp;</operator><name>now</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name>inter</name> <operator>=</operator> <name>now</name> <operator>-</operator> <name><name>dns_ctx</name><operator>-&gt;</operator><name>begin</name></name></expr>;</expr_stmt>

	<comment type="block">/* Èç¹û²éÑ¯Ê±¼ä¹ý³¤£¬Ôò¸ø³ö¾¯¸æÐÅÏ¢ */</comment>
	<if_stmt><if>if <condition>(<expr><name>inter</name> <operator>&gt;=</operator> <literal type="number">5</literal></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><call><name>acl_msg_warn</name><argument_list>(<argument><expr><literal type="string">"%s(%d): dns search time=%d, domain(%s)"</literal></expr></argument>,
			<argument><expr><name>myname</name></expr></argument>, <argument><expr><name>__LINE__</name></expr></argument>, <argument><expr><call><name>time</name><argument_list>(<argument><expr><name>NULL</name></expr></argument>)</argument_list></call> <operator>-</operator> <name><name>dns_ctx</name><operator>-&gt;</operator><name>begin</name></name></expr></argument>,
			<argument><expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></if></if_stmt>

	<while>while <condition>(<expr><literal type="number">1</literal></expr>)</condition> <block>{<block_content>
		<expr_stmt><expr><name>ring_ptr</name> <operator>=</operator> <call><name>acl_ring_pop_head</name><argument_list>(<argument><expr><operator>&amp;</operator><name><name>list</name><operator>-&gt;</operator><name>ring</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<if_stmt><if>if <condition>(<expr><name>ring_ptr</name> <operator>==</operator> <name>NULL</name></expr>)</condition><block type="pseudo"><block_content>
			<break>break;</break></block_content></block></if></if_stmt>

		<expr_stmt><expr><name><name>list</name><operator>-&gt;</operator><name>nrefer</name></name><operator>--</operator></expr>;</expr_stmt>

		<expr_stmt><expr><name>entry</name> <operator>=</operator> <call><name>ACL_RING_TO_APPL</name><argument_list>(<argument><expr><name>ring_ptr</name></expr></argument>, <argument><expr><name>CLIENT_ENTRY</name></expr></argument>, <argument><expr><name>dns_entry</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>tm</name><operator>.</operator><name>dns_lookup</name></name> <operator>=</operator> <name>now</name> <operator>-</operator> <name><name>entry</name><operator>-&gt;</operator><name>tm</name><operator>.</operator><name>stamp</name></name></expr>;</expr_stmt>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>tm</name><operator>.</operator><name>stamp</name></name> <operator>=</operator> <name>now</name></expr>;</expr_stmt>

		<if_stmt><if>if <condition>(<expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>ip_cnt</name></name> <operator>&lt;=</operator> <literal type="number">0</literal></expr>)</condition> <block>{<block_content>
			<expr_stmt><expr><call><name>acl_msg_error</name><argument_list>(<argument><expr><literal type="string">"%s(%d): dns not found domain(%s)"</literal></expr></argument>,
				<argument><expr><name>myname</name></expr></argument>, <argument><expr><name>__LINE__</name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
			<if_stmt><if>if <condition>(<expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name> <operator>==</operator> <name>NULL</name></expr>)</condition><block type="pseudo"><block_content>
				<expr_stmt><expr><call><name>acl_msg_fatal</name><argument_list>(<argument><expr><literal type="string">"%s(%d): client null"</literal></expr></argument>,
					<argument><expr><name>__FILE__</name></expr></argument>, <argument><expr><name>__LINE__</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></if></if_stmt>

			<if_stmt><if>if <condition>(<expr><name><name>entry</name><operator>-&gt;</operator><name>dns_errmsg</name></name></expr>)</condition> <block>{<block_content>
				<comment type="block">/* XXX: ÒòÎª´Ë´¦¿ÉÄÜ»áÓÐÁ½´¦¹Ø±Õ client Á÷µÄµØ·½:
				 * acl_aio_writen ¼° forward_complete£¬Îª·ÀÖ¹ÖØ¸´
				 * ¹Ø±ÕÔì³ÉµÄÄÚ´æ·ÃÎÊ·Ç·¨£¬ÐèÒª * ÔÚµÚÒ»¸ö¿ÉÄÜ¹Ø±Õ
				 * µÄº¯Êý(acl_aio_writen)µ÷ÓÃÇ°ÌáÉý client Á÷µÄ
				 * ÒýÓÃÖµ£¬²¢ÇÒÔÚ¸Ãº¯Êý·µ»ØºóÔÙ»Ö¸´ÒýÓÃÖµ
				 */</comment>

				<expr_stmt><expr><call><name>acl_aio_refer</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
				<expr_stmt><expr><call><name>acl_aio_writen</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name></expr></argument>, <argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_errmsg</name></name></expr></argument>,
					<argument><expr><operator>(</operator><name>int</name><operator>)</operator> <call><name>strlen</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_errmsg</name></name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
				<comment type="block">/* »Ö¸´referÖµ */</comment>
				<expr_stmt><expr><call><name>acl_aio_unrefer</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>client</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
			</block_content>}</block></if></if_stmt>

			<expr_stmt><expr><call><name><name>entry</name><operator>-&gt;</operator><name>nslookup_notify_fn</name></name><argument_list>(<argument><expr><name>entry</name></expr></argument>, <argument><expr><name>NSLOOKUP_ERR</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

			<continue>continue;</continue>
		</block_content>}</block></if></if_stmt>

		<if_stmt><if>if <condition>(<expr><call><name>acl_do_debug</name><argument_list>(<argument><expr><literal type="number">20</literal></expr></argument>, <argument><expr><literal type="number">2</literal></expr></argument>)</argument_list></call></expr>)</condition> <block>{<block_content>
			<decl_stmt><decl><type><name>int</name></type>   <name>i</name></decl>;</decl_stmt>

			<for>for <control>(<init><expr><name>i</name> <operator>=</operator> <literal type="number">0</literal></expr>;</init> <condition><expr><name>i</name> <operator>&lt;</operator> <name><name>dns_ctx</name><operator>-&gt;</operator><name>ip_cnt</name></name></expr>;</condition> <incr><expr><name>i</name><operator>++</operator></expr></incr>)</control><block type="pseudo"><block_content>
				<expr_stmt><expr><call><name>acl_msg_info</name><argument_list>(<argument><expr><literal type="string">"%s(%d): domain(%s), ip%d(%s)"</literal></expr></argument>,
					<argument><expr><name>myname</name></expr></argument>, <argument><expr><name>__LINE__</name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>,
					<argument><expr><name>i</name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>ip</name><index>[<expr><name>i</name></expr>]</index></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></for>
		</block_content>}</block></if></if_stmt>
		
		<comment type="block">/* ½«²éµÃµÄËùÓÐDNS½á¹û¶¼¿½±´ÖÁÇëÇó¶ÔÏóÖÐ */</comment>
		<expr_stmt><expr><call><name>memcpy</name><argument_list>(<argument><expr><operator>&amp;</operator><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name></name></expr></argument>, <argument><expr><name>dns_ctx</name></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>

		<comment type="block">/* ÏÂÃæ×¢ÊÍ²¿·Ö±»´ò¿ª£¬±ã¿ÉÒÔ²âÊÔÁ¬½ÓÖØÊÔ¹¦ÄÜ:)-- zsx, 2008.2.28
		 * strcpy(proxy_entry-&gt;dns_ctx.ip[1], proxy_entry-&gt;dns_ctx.ip[0]);
		 * strcpy(proxy_entry-&gt;dns_ctx.ip[0], "127.0.0.1");
		 * if (proxy_entry-&gt;dns_ctx.ip_cnt &lt; 2)
		 *	proxy_entry-&gt;dns_ctx.ip_cnt = 2;
		 */</comment>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>ip_idx</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
		<expr_stmt><expr><call><name><name>entry</name><operator>-&gt;</operator><name>nslookup_notify_fn</name></name><argument_list>(<argument><expr><name>entry</name></expr></argument>, <argument><expr><name>NSLOOKUP_OK</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></while>

	<expr_stmt><expr><call><name>acl_htable_delete</name><argument_list>(<argument><expr><name><name>service</name><operator>-&gt;</operator><name>dns_table</name></name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>, <argument><expr><name>NULL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt><if>if <condition>(<expr><name><name>list</name><operator>-&gt;</operator><name>nrefer</name></name> <operator>&lt;=</operator> <literal type="number">0</literal></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><call><name>acl_myfree</name><argument_list>(<argument><expr><name>list</name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></if>
	<else>else<block type="pseudo"><block_content>
		<expr_stmt><expr><call><name>acl_msg_fatal</name><argument_list>(<argument><expr><literal type="string">"%s(%d): list's nrefer=%d"</literal></expr></argument>,
			<argument><expr><name>myname</name></expr></argument>, <argument><expr><name>__LINE__</name></expr></argument>, <argument><expr><name><name>list</name><operator>-&gt;</operator><name>nrefer</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></else></if_stmt>
</block_content>}</block></function>

<comment type="block">/* ²éÑ¯DNSÐÅÏ¢£¬²ÉÓÃÍâ¹ÒÄ£¿éµÄ·½Ê½ */</comment>
<function><type><specifier>static</specifier> <name>void</name></type> <name>thrpool_nslookup</name><parameter_list>(<parameter><decl><type><name>SERVICE</name> <modifier>*</modifier></type><name>service</name></decl></parameter>, <parameter><decl><type><name>CLIENT_ENTRY</name> <modifier>*</modifier></type><name>entry</name></decl></parameter>,
	<parameter><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>domain</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>port</name></decl></parameter>)</parameter_list>
<block>{<block_content>
	<decl_stmt><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>myname</name> <init>= <expr><literal type="string">"thrpool_nslookup"</literal></expr></init></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>DNS_CTX</name></type> <name>dns_ctx</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>DNS_RING</name> <modifier>*</modifier></type><name>list</name></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>char</name> <modifier>*</modifier></type><name>ptr</name></decl>;</decl_stmt>

	<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>tm</name><operator>.</operator><name>stamp</name></name> <operator>=</operator> <call><name>time</name><argument_list>(<argument><expr><name>NULL</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<expr_stmt><expr><call><name>memset</name><argument_list>(<argument><expr><operator>&amp;</operator><name>dns_ctx</name></expr></argument>, <argument><expr><literal type="number">0</literal></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>dns_ctx</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name><name>dns_ctx</name><operator>.</operator><name>begin</name></name> <operator>=</operator> <name><name>entry</name><operator>-&gt;</operator><name>tm</name><operator>.</operator><name>stamp</name></name></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>STRNCPY</name><argument_list>(<argument><expr><name><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>, <argument><expr><name>domain</name></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name>ptr</name> <operator>=</operator> <call><name>strchr</name><argument_list>(<argument><expr><name><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>, <argument><expr><literal type="char">':'</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<comment type="block">/* ½öÁôÏÂÓòÃû²¿·Ö */</comment>
	<if_stmt><if>if <condition>(<expr><name>ptr</name></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><operator>*</operator><name>ptr</name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt></block_content></block></if></if_stmt>

	<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>server_port</name></name> <operator>=</operator> <name>port</name></expr>;</expr_stmt>
	<if_stmt><if>if <condition>(<expr><name><name>entry</name><operator>-&gt;</operator><name>server_port</name></name> <operator>&lt;=</operator> <literal type="number">0</literal></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>server_port</name></name> <operator>=</operator> <literal type="number">80</literal></expr>;</expr_stmt></block_content></block></if></if_stmt>
	
	<comment type="block">/* ½«ÓòÃû×Ö·û´®¶¼×ª»»³ÉÐ¡Ð´£¬ÒÔ±ãÓÚ½øÐÐ¹þÏ£²éÑ¯ */</comment>
	<expr_stmt><expr><call><name>acl_lowercase</name><argument_list>(<argument><expr><name><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<expr_stmt><expr><name><name>dns_ctx</name><operator>.</operator><name>context</name></name> <operator>=</operator> <name>service</name></expr>;</expr_stmt>
	<expr_stmt><expr><name><name>dns_ctx</name><operator>.</operator><name>callback</name></name> <operator>=</operator> <name>thrpool_nslookup_complete</name></expr>;</expr_stmt>

	<expr_stmt><expr><call><name>STRNCPY</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<comment type="block">/* ÏÈ²éÑ¯DNS²éÑ¯±íÖÐÊÇ·ñÒÑ¾­°üº¬±¾´ÎÐèÒª±»²éÑ¯µÄÓòÃû */</comment>
	<expr_stmt><expr><name>list</name> <operator>=</operator> <operator>(</operator><name>DNS_RING</name> <operator>*</operator><operator>)</operator> <call><name>acl_htable_find</name><argument_list>(<argument><expr><name><name>service</name><operator>-&gt;</operator><name>dns_table</name></name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<if_stmt><if>if <condition>(<expr><name>list</name></expr>)</condition> <block>{<block_content>
		<comment type="block">/* ½«±¾´Î¶ÔÍ¬Ò»ÓòÃûµÄ²éÑ¯Ìí¼Ó½øÍ¬Ò»¸ö²éÑ¯Á´ÖÐ */</comment>
		<expr_stmt><expr><call><name>acl_ring_prepend</name><argument_list>(<argument><expr><operator>&amp;</operator><name><name>list</name><operator>-&gt;</operator><name>ring</name></name></expr></argument>, <argument><expr><operator>&amp;</operator><name><name>entry</name><operator>-&gt;</operator><name>dns_entry</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<comment type="block">/* ½«²éÑ¯Á´¶ÔÏóµÄÒýÓÃ¼ÆÊý¼Ó1 */</comment>
		<expr_stmt><expr><name><name>list</name><operator>-&gt;</operator><name>nrefer</name></name><operator>++</operator></expr>;</expr_stmt>
		<comment type="block">/* Èç¹û¸Ã²éÑ¯Á´ÒÑ¾­´æÔÚ£¬ËµÃ÷ÓÐ²éÑ¯ÈÎÎñµÈ´ý·µ»Ø£¬Æä·µ»Øºó»áÒ»Í¬½«
		 * ±¾´ÎÈÎÎñ½øÐÐ´¥·¢£¬Èç¹û´Ë´¦´¥·¢ÐÂÈÎÎñ£¬Ôò»áÔì³ÉÄÚ´æ·ÃÎÊ³åÍ»£¬ÒòÎª
		 * ²éÑ¯DNSµÄ¹ý³ÌÊÇÓÉÒ»×éÏß³Ì³Ø½øÐÐ²éÑ¯µÄ¡£
		 * (void) dns_server_lookup(proxy_entry-&gt;aio_proxy-&gt;dns_server, &amp;dns_ctx);
		 */</comment>
		<return>return;</return>
	</block_content>}</block></if></if_stmt>

	<comment type="block">/* ´´½¨Ò»¸öÐÂµÄ²éÑ¯Á´¶ÔÏó£¬²¢½«±¾´Î²éÑ¯ÈÎÎñ¼ÓÈë¸Ã²éÑ¯Á´ÖÐ¼°½«¸Ã²éÑ¯Á´¼ÓÈë²éÑ¯±íÖÐ */</comment>

	<expr_stmt><expr><name>list</name> <operator>=</operator> <operator>(</operator><name>DNS_RING</name> <operator>*</operator><operator>)</operator> <call><name>acl_mycalloc</name><argument_list>(<argument><expr><literal type="number">1</literal></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name>DNS_RING</name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>acl_ring_init</name><argument_list>(<argument><expr><operator>&amp;</operator><name><name>list</name><operator>-&gt;</operator><name>ring</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><call><name>STRNCPY</name><argument_list>(<argument><expr><name><name>list</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>, <argument><expr><name><name>dns_ctx</name><operator>.</operator><name>domain_key</name></name></expr></argument>, <argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>list</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>

	<comment type="block">/* ½«±¾´Î²éÑ¯ÈÎÎñ¼ÓÈëÐÂµÄ²éÑ¯Á´ÖÐÇÒ½«²éÑ¯Á´µÄÒýÓÃ¼ÆÊý¼Ó1 */</comment>
	<expr_stmt><expr><call><name>acl_ring_prepend</name><argument_list>(<argument><expr><operator>&amp;</operator><name><name>list</name><operator>-&gt;</operator><name>ring</name></name></expr></argument>, <argument><expr><operator>&amp;</operator><name><name>entry</name><operator>-&gt;</operator><name>dns_entry</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	<expr_stmt><expr><name><name>list</name><operator>-&gt;</operator><name>nrefer</name></name><operator>++</operator></expr>;</expr_stmt>

	<comment type="block">/* ½«ÐÂµÄ²éÑ¯Á´¼ÓÈë²éÑ¯±íÖÐ */</comment>
	<if_stmt><if>if <condition>(<expr><call><name>acl_htable_enter</name><argument_list>(<argument><expr><name><name>service</name><operator>-&gt;</operator><name>dns_table</name></name></expr></argument>, <argument><expr><name><name>list</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>, <argument><expr><operator>(</operator><name>char</name> <operator>*</operator><operator>)</operator> <name>list</name></expr></argument>)</argument_list></call> <operator>==</operator> <name>NULL</name></expr>)</condition><block type="pseudo"><block_content>
		<expr_stmt><expr><call><name>acl_msg_fatal</name><argument_list>(<argument><expr><literal type="string">"%s: add domain(%s) to table error"</literal></expr></argument>, <argument><expr><name>myname</name></expr></argument>, <argument><expr><name><name>list</name><operator>-&gt;</operator><name>domain_key</name></name></expr></argument>)</argument_list></call></expr>;</expr_stmt></block_content></block></if></if_stmt>

	<comment type="block">/* ¿ªÊ¼Æô¶¯DNS²éÑ¯¹ý³Ì */</comment>
	<expr_stmt><expr><operator>(</operator><name>void</name><operator>)</operator> <call><name>dns_server_lookup</name><argument_list>(<argument><expr><name><name>service</name><operator>-&gt;</operator><name>dns_server</name></name></expr></argument>, <argument><expr><operator>&amp;</operator><name>dns_ctx</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
</block_content>}</block></function>

<comment type="block">/*----------------------------------------------------------------------------*/</comment>

<function><type><name>void</name></type> <name>dns_lookup</name><parameter_list>(<parameter><decl><type><name>CLIENT_ENTRY</name> <modifier>*</modifier></type><name>entry</name></decl></parameter>, <parameter><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>domain</name></decl></parameter>, <parameter><decl><type><name>int</name></type> <name>port</name></decl></parameter>)</parameter_list>
<block>{<block_content>
	<decl_stmt><decl><type><specifier>const</specifier> <name>char</name> <modifier>*</modifier></type><name>myname</name> <init>= <expr><literal type="string">"dns_lookup"</literal></expr></init></decl>;</decl_stmt>
	<decl_stmt><decl><type><name>SERVICE</name> <modifier>*</modifier></type><name>service</name> <init>= <expr><name><name>entry</name><operator>-&gt;</operator><name>service</name></name></expr></init></decl>;</decl_stmt>

	<if_stmt><if>if <condition>(<expr><call><name>acl_is_ip</name><argument_list>(<argument><expr><name>domain</name></expr></argument>)</argument_list></call></expr>)</condition> <block>{<block_content>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>ip_idx</name></name> <operator>=</operator> <literal type="number">0</literal></expr>;</expr_stmt>
		<expr_stmt><expr><call><name>ACL_SAFE_STRNCPY</name><argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip</name><index>[<expr><literal type="number">0</literal></expr>]</index></name></expr></argument>, <argument><expr><name>domain</name></expr></argument>,
			<argument><expr><sizeof>sizeof<argument_list>(<argument><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip</name><index>[<expr><literal type="number">0</literal></expr>]</index></name></expr></argument>)</argument_list></sizeof></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>port</name><index>[<expr><literal type="number">0</literal></expr>]</index></name> <operator>=</operator> <name>port</name></expr>;</expr_stmt>
		<expr_stmt><expr><name><name>entry</name><operator>-&gt;</operator><name>dns_ctx</name><operator>.</operator><name>ip_cnt</name></name> <operator>=</operator> <literal type="number">1</literal></expr>;</expr_stmt>
		<expr_stmt><expr><call><name><name>entry</name><operator>-&gt;</operator><name>nslookup_notify_fn</name></name><argument_list>(<argument><expr><name>entry</name></expr></argument>, <argument><expr><name>NSLOOKUP_OK</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
		<return>return;</return>
	</block_content>}</block></if> <if type="elseif">else if <condition>(<expr><name><name>service</name><operator>-&gt;</operator><name>dns_handle</name></name></expr>)</condition> <block>{<block_content>
		<expr_stmt><expr><call><name>inner_nslookup</name><argument_list>(<argument><expr><name>service</name></expr></argument>, <argument><expr><name>entry</name></expr></argument>, <argument><expr><name>domain</name></expr></argument>, <argument><expr><name>port</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></if> <if type="elseif">else if <condition>(<expr><name><name>service</name><operator>-&gt;</operator><name>dns_server</name></name></expr>)</condition> <block>{<block_content>
		<expr_stmt><expr><call><name>thrpool_nslookup</name><argument_list>(<argument><expr><name>service</name></expr></argument>, <argument><expr><name>entry</name></expr></argument>, <argument><expr><name>domain</name></expr></argument>, <argument><expr><name>port</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></if> <else>else <block>{<block_content>
		<expr_stmt><expr><call><name>acl_msg_fatal</name><argument_list>(<argument><expr><literal type="string">"%s(%d): no dns lookup set"</literal></expr></argument>, <argument><expr><name>myname</name></expr></argument>, <argument><expr><name>__LINE__</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
	</block_content>}</block></else></if_stmt>
</block_content>}</block></function>
</unit>
